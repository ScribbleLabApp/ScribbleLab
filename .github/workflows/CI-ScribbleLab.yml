name: CI-ScribbleLab
on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
jobs:
  setup-workflow:
    name: Setup Environment
    runs-on: macos-13
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
      - name: Set up Ruby ğŸ’
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2.2
      - name: Install Slather ğŸ’
        run: gem install slather
      - name: Install Homebrew ğŸº
        run: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - name: Install swiftlint ğŸº
        run: brew install swiftlint
      - name: List Xcode Versions ğŸ“‹
        run: ls /Applications | grep Xcode
      - name: Select Xcode âœ¨
        run: sudo xcode-select -switch /Applications/Xcode_15.0.1.app/Contents/Developer
      - name: Delete DerivedData directory ğŸ—‘ï¸
        run: rm -rf ~/Library/Developer/Xcode/DerivedData
      - name: List SDKs ğŸŠ
        run: xcodebuild -showsdks
      - name: List Simulators ğŸ“±
        run: xcrun simctl list --json
      
  run-tests:
    name: Build ScribbleLab and execute tests
    runs-on: macos-13
    needs: setup-workflow
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
      - name: Run tests (UI & Unit tests) âœ…
        run: xcodebuild -scheme ScribbleLab -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation)' test
  
  coverage:
    name: Generate coverage report
    runs-on: macos-13
    needs: run-tests
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
      - name: Generate Coverage Report ğŸ’
        run: slather coverage --cobertura-xml
  
  upload-coverage:
    name: Upload coverage report to Codecov
    runs-on: macos-13
    needs: coverage
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
      - name: Upload Coverage to Codecov ğŸ“Š
        uses: codecov/codecov-action@v3
        with:
          file: ./cobertura.xml
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
